import React from 'react';
import Output from './Output';
import App from '../App';
import Cookies from 'js-cookie';
import jwt from 'jsonwebtoken';
import axios from 'axios';
var ObjectID = require('mongodb').ObjectID;

//makeid to save profile pics and associate them with the users
function makeprofilepicid(length) {
    var result           = '';
    var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for ( var i = 0; i < length; i++ ) {
       result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result + ".png";
 }

class Picture extends React.Component{

    profilepicfile = "";

    constructor(){
        super();
        this.state = {
            profilepic: '',
            mail: '',
            firstname: '',
            lastname: '',
            address: '',
            phone: '',
            mail: '',
            fax: '',
            url: '',
            fieldofwork: '',
            insurednumber: '',
            healthinsurance: '',
            isDoc: '',
            patid: '',
            userid: '',
            docid: '',
            profilepicfile: ''
        };
        
        //always passing our token so the site can verify wether we're logged in or not
        axios.defaults.headers.common['token'] = Cookies.get("token");
        
          
    }

    handleInputChange = e => {
        this.setState({
          [e.target.name]: e.target.value,
        });
    };

    handleSubmit = e =>
    {
        e.preventDefault();
        const {mail, firstname, lastname, password, address, agreement, insurednumber, healthinsurance, profilepic, patid, userid} = this.state;
        const form_data = new FormData();
        //If a profile pic is sent, it's name gets replaced by a string for identification. this string is once saved in the user table and accesable via uploads/newfilename
        const user = {
            mail,
            firstname,
            lastname,
            password,
            address,
            agreement,
            userid,
            profilepic
        }
        
        if(e.target.profilepic.files[0])
        {
            const newfilename = makeprofilepicid(20);
            form_data.append("file", e.target.profilepic.files[0]);
            form_data.append("newfilename", newfilename);
            user.profilepic = newfilename;
        }
       
        const patient = {
            insurednumber,
            healthinsurance,
            patid
        };
        
        console.log("user profilepic: " + user.profilepic);

        //using axios to post
        axios
        .post('http://localhost:8080/edit-sent-user', user)
            .then(() => console.log('User updated :))'))
            .catch(err => {
                console.error(err);
        });
        axios
        .post('http://localhost:8080/edit-sent-patient', patient)
            .then(() => console.log('Patient updated :))'))
            .catch(err => {
                console.error(err);
        });
        const headerss = {
            'content-type': 'multipart/form-data'
        }
        if(e.target.profilepic.files[0])
        {
            axios
            .post('http://localhost:8080/profilepic-sent', form_data,{headerss})
                .then(() => console.log('Profilepic set.'))
                .catch(err => {
                    console.error(err);
            });
        }


        /*this.setState({sendForm: this.state.name});
        event.preventDefault();*/
    }

    setUsername(username)
    {
        this.username = username;
        console.log("username: " + username);
    }

    //using axios in here to get access to the response of our backend in our frontend
    componentDidMount () {
        const url = 'http://localhost:8080/me';
        const options = {
        method: 'GET',
        headers: {
            'token': Cookies.get("token"),
        },
        };
        axios.get(url, options)
        .then(response => {
            //console.log(response.json({message: "request received!", response}));
            //this.state.mail = response.json({message: "request received!", response}).parse();
            //console.log (response.json());
            //this.state.mail = response.data.firstname;
            //console.log(response.data);
            //this.setUsername(response.data.firstname)
            //this.setState(resp);
            //console.log(response.data);
            console.log(response.data.profilepic);
            if(response.data.user.profilepic)
            {
                this.setState({profilepic: response.data.user.profilepic});
                this.setState({profilepicfile: response.data.user.profilepic});
            }
            this.setState({userid: response.data.user._id});
            //this.setState({patid: response.data.patient._id});
            //this.setState({mail: response.data.patient.mail});
            this.setState({firstname: response.data.user.firstname});
            this.setState({lastname: response.data.user.lastname});
            this.setState({password: response.data.user.password});
            this.setState({address: response.data.user.address});
            this.setState({isDoc: response.data.user.isDoc});
            //this.setState({insurednumber: response.data.patient.insurednumber});
            //this.setState({healthinsurance: response.data.patient.healthinsurance});
        });

      

        

        /*fetch('http://localhost:8080/me')
            .then(response => {
                if (!response.ok) {
                    throw Error('Network request failed.')
                }
                return response;
            })
            .then(data => data.json())
            .then(data => {
                this.setState({
                    persons: data
                });
                console.log('parsed json', data);            
            }, (ex) => {
                this.setState({
                    requestError : true
                });
                console.log('parsing failed', ex)
            })*/

        /*axios.get('http://localhost:8080/me',
        { headers: { 'token':  Cookies.get("token") } }
        ).then((data)=>{
            console.log('data comming',data);
        }).catch((error)=>{
            console.log('error comming',error);
        });*/
    }  

    isDoc()
    {
        if(this.state.isDoc == "1")
            return true;
        else
            return false;
    }

    

    startCamera(args={})
    {
        const controls = args.controls || document.querySelector('.controls') || false;
        const cameraOptions = args.cameraOptions || document.querySelector('.video-options>select');
        const video = args.video || document.querySelector('video');
        const canvas = args.canvas || document.querySelector('canvas');
        const screenshotImage = args.screenshot || document.querySelector('img');
        const buttons = [...controls.querySelectorAll('button')];
        let streamStarted = false;

        var _stream = false;

        const constraints = {
            video: {
                width: {
                    min: 1280,
                    ideal: 1920,
                    max: 2560
                },
                height: {
                    min: 720,
                    ideal: 1080,
                    max: 1440
                },
            }
        };

        const [play, pause, accept, reject, screenshot, close] = buttons;

        play.onclick = () => {
            if('mediaDevices' in navigator && navigator.mediaDevices.getUserMedia){
                const updatedConstraints = {
                    ...constraints,
                    deviceId: {
                        exact: cameraOptions.value
                    }
                };
                startStream(updatedConstraints);


            }
        }

        const startStream = async(constraints) => {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
    
            video.srcObject = stream;
            _stream = stream;
        };

        const getCameraSelection = async() => {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = 
                devices.filter(device => device.kind === 'videoinput');
            const options = videoDevices.map(videoDevice => {
                return '<option value="${videoDevice.deviceId}">${videoDevice.label}</option>';
            });
            cameraOptions.innerHTML = options.join('');
        };

        screenshot.onclick = () => {
            canvas.width = video.videoWidth;
            canvas.heigth = video.videoHeigth;
            canvas.getContext('2d').drawImage(video, 0, 0);
            screenshotImage.src = canvas.toDataURL('image/webp');
            //show img
        };

        reject.onclick = () => {
            //hide img
        };

        pause.onclick = () => {
            video.pause();
        };

        close.onclick = () => {
            if(_stream)
            {
                _stream.getTracks().forEach(function(track){
                    track.stop();
                });
            }
        };

        accept.onclick = () => {
            close.click();

            let file = this.base64ToFile(screenshotImage.src,
                'camera' + (new Date().getTime()) + '.webp');

            if(file)
            {
                let evt = new DragEvent('drop');
                Object.defineProperty(evt, 'dataTransfer', {
                    value: new this.MyDataTransfer(file)
                });

                document.getElementById('uploadFile').dispatchEvent(
                    evt
                );
            }
        }

    }

    downloadBase64File(data = false, fileName = false, mimeType = false){
        if(!data || !fileName || !mimeType)
            return false;

        const linkSource = 'data:${mimeType};base64,${contentBase64}';
        const downloadLink = document.createElement('a');
        document.body.appendChild(downloadLink);

        downloadLink.hred = linkSource;
        downloadLink.target = '_self';
        downloadLink.download = fileName;
        downloadLink.click();
    }

    MyDataTransfer(file) {
        this.dropEffect = 'all';
        this.effectAllowed = 'all';
        this.items = [file];
        this.types = ['Files'];
        this.getData = function() {
            return file;
        };
        this.files = [file];
    }

    base64ToFile(data = false, fileName = false)
    {
        if(!data || !fileName)
            return false;

        var arr = data.split(','),
        mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]),
        n = bstr.length,
        u8arr = new Uint8Array(n);

        while(n--)
        {
            u8arr[n] = bstr.charCodeAt(n);
        }

        return new File([u8arr], fileName, {type: mime}) || false;
    }

    docContent()
    {
        {this.startCamera()}
        return(
            <div>

            <div>
                <div>
                    <video autoPlay></video>
                    <canvas className="d-none"></canvas>
                </div>
                <div className="video-options input">
                    <select name="" id="" className="custom-select">
                        <option value="">Select camera</option>
                    </select>
                </div>

                <img className="screenshot-image hidden" alt="" />

            </div>

            <div className="controls">
                <button className="icon icon-cross" title="play"></button>
                <button className="icon icon-checkmark hidden" title="pause"></button>
                <button className="icon icon-checkmark hidden" title="accept"></button>
                <button className="icon icon-spinner11 hidden" title="reject"></button>
                <button className="icon icon-radio-unchecked" title="take photo"></button>
                <button className="icon icon-cross" title="close camera"></button>
            </div>

            </div>




        );
    }

    checkProfilepic()
    {
        if(this.state.profilepicfile)
            return (<img src = {require("../uploads/" + this.state.profilepicfile)} />);
        else
            return ("no image");
    }

    patientContent()
    {
        return(
        <div>
            <div className="title">
                Profileedit
            </div>


            <div className="bg-right"></div>

            <form onSubmit={this.handleSubmit} encType="multipart/formdata">
                
                <div className="mail">
                    <div className="input_field">
                        <input type="text" placeholder="Eemail" value={this.state.mail} className="input" name="mail" onChange={this.handleInputChange}/>
                        <i className="mail"></i>
                    </div>
                </div>

                <div className="vorName">
                    <div className="input_field">
                        <input name="firstname" type="text" value={this.state.firstname} placeholder="Vorname" className="input" onChange={this.handleInputChange}/>
                        <i className="name"></i>
                    </div>

                </div>

                <div className="nachName">
                    <div className="input_field">
                        <input type="text" placeholder="Nachname" value={this.state.lastname} className="input" name="lastname" onChange={this.handleInputChange}/>
                        <i className="name"></i>
                    </div>
                </div>


                <div className="pass">
                    <div className="input_field">
                        <input name="password" type="password"  placeholder="Passwort" className="input" onChange={this.handleInputChange}/>
                        <i className="enlock"></i>
                    </div>
                </div>

                <div className="anschrift">
                    <div className="input_field">
                        <input type="text" placeholder="Anschrift" value={this.state.address} className="input" name="address" onChange={this.handleInputChange}/>
                        <i className="anschrift"></i>
                    </div>
                </div>


                <div className="kk">
                    <div className="input_field">
                        <input list="kk" placeholder="Krankenkasse" className="input" value={this.state.healthinsurance} name="healthinsurance" onChange={this.handleInputChange}/>
                        <datalist id="kk">
                            <option value="AOK" />
                            <option value="Knappschaft" />
                            <option value="Innungskrankenkasse" />
                            <option value="DAK Gesundheit" />
                            <option value="BARMER" />
                        </datalist>
                    </div>
                </div>

                <div className="verNr">
                <div className="input_field">
                    <input type="text" placeholder="Versichertennummer" className="input" value={this.state.insurednumber} name="insurednumber" onChange={this.handleInputChange}/>
                    <i className="verNr"></i>
                </div>
                </div>
                {this.checkProfilepic()}

                <input type="file" name="profilepic" onChange={this.handleInputChange}/> <br/>
                
                <input type="submit" className="btn btn-primary" value="Submit" />
                
            </form>
        </div>

        )
    }

    getContent()
    {
        if(this.isDoc())
        {
            console.log("u docc");
            return this.docContent();
        }
        else
        {
            console.log("u patt");
            return this.patientContent();

        }
    }

    checkLogin(mail)
    {
        
            return mail()

            /*try {
                const decoded = jwt.verify(this.state.token, "randomString");
                //return "it is: " + decoded.user;
                const user = User.findById(req.user.id);
            } catch (e) {
                console.error(e);
            }*/
    }

    render(){

        return this.getContent();
    }
}

export default Picture;